name: Nightly Build

on:
  schedule:
    # Runs every night at 03:00 UTC; adjust as needed
    - cron: "0 3 * * *"
  workflow_dispatch: {}  # allow manual runs from the UI

permissions:
  contents: write   # needed to create/update releases & upload assets
  packages: read    # needed to pull GHCR image

jobs:
  build-nightly-linux-container:
    if: github.repository_owner == 'OpenJE'
    runs-on: ubuntu-latest

    steps:
      - name: Checkout source
        uses: actions/checkout@v4
        with:
            submodules: recursive
            fetch-depth: 0

      - name: Log in to GitHub Container Registry
        run: |
          echo "${{ secrets.GITHUB_TOKEN }}" |
            docker login ghcr.io -u "${{ github.actor }}" --password-stdin

      - name: Pull docker container (MSVC 2002)
        run: |
          docker pull ghcr.io/openje/msvc2002:latest

      - name: Build with MSVC 2002
        shell: bash
        working-directory: ${{ github.workspace }}
        run: |
          mkdir -p obj
          mkdir -p openje/obj
          mkdir -p tracing/obj
          mkdir -p build
          
          # 1) Fix permissions on the mounted repo so UID 1000 can write
          docker run --rm \
            -u 0:0 \
            -v "$PWD":"$PWD" \
            -w "$PWD" \
            ghcr.io/openje/msvc2002:latest \
            -lc 'chown -R 1000:1000 "$PWD"'
      
          # 2) Run the actual build as UID 1000 (from Dockerfile USER 1000:1000)
          docker run --rm \
            -v "$PWD":"$PWD" \
            -w "$PWD" \
            ghcr.io/openje/msvc2002:latest \
            -lc 'nmake /f Makefile CFG="Debug"'

          docker run --rm \
            -v "$PWD":"$PWD" \
            -w "$PWD" \
            ghcr.io/openje/msvc2002:latest \
            -lc 'nmake /f Makefile'

      - name: Locate EXEs (Debug + Release)
        id: find-exe
        run: |
          set -e

          # Find up to 2 exe files – adjust pattern/path as needed
          exes=$(find . -maxdepth 6 -type f -iname '*.exe' | head -n 2)

          if [ -z "$exes" ]; then
            echo "No EXEs found" >&2
            exit 1
          fi

          # Turn the list into a single comma-separated line for release-action
          artifacts=$(printf "%s" "$exes" | paste -sd "," -)

          echo "artifacts=$artifacts" >> "$GITHUB_OUTPUT"
          echo "Found EXEs: $artifacts"

      - name: Create or update 'nightly' release and upload EXE
        uses: ncipollo/release-action@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag: nightly
          name: Nightly
          body: |
            Nightly build (Linux host invoking MSVC 2002 container).
            Commit: ${{ github.sha }}
            Ref: ${{ github.ref }}
            Workflow run: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
          artifacts: ${{ steps.find-exe.outputs.artifacts }}
          artifactContentType: application/octet-stream
          allowUpdates: true
          replacesArtifacts: true
          makeLatest: false
          prerelease: true

  build-nightly-windows-msvc:
    if: github.repository_owner != 'OpenJE'
    runs-on: windows-latest

    steps:
      - name: Checkout source
        uses: actions/checkout@v4
        with:
            submodules: recursive
            fetch-depth: 0

      - name: Set up MSVC Developer Command Prompt
        uses: ilammy/msvc-dev-cmd@v1
        with:
          arch: x86   # or x64

      - name: Build with nmake (latest MSVC)
        run: |
          nmake /f Makefile CFG="Debug"

      - name: Build with nmake (latest MSVC)
        run: |
          nmake /f Makefile

      - name: Locate EXEs (Debug + Release)
        id: find-exe
        shell: pwsh
        run: |
          # Find up to 2 exe files – adjust path/pattern to match your layout
          $exes = Get-ChildItem -Path . -Recurse -Filter *.exe | Select-Object -First 2

          if (-not $exes) {
            Write-Error "No EXEs found"
            exit 1
          }

          # Join full paths into a comma-separated list
          $paths = $exes | ForEach-Object { $_.FullName } -join ","

          "artifacts=$paths" >> $env:GITHUB_OUTPUT
          Write-Host "Found EXEs: $paths"

      - name: Create or update 'nightly' release and upload EXE
        uses: ncipollo/release-action@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag: nightly
          name: Nightly
          body: |
            Nightly build (Windows MSVC).
            Commit: ${{ github.sha }}
            Ref: ${{ github.ref }}
            Workflow run: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
          artifacts: ${{ steps.find-exe.outputs.artifacts }}
          artifactContentType: application/octet-stream
          allowUpdates: true
          replacesArtifacts: true
          makeLatest: false
          prerelease: true
