name: Release Build

on:
  release:
    types: [published]  # fires when you publish a GitHub Release
  workflow_dispatch: {}  # allow manual trigger for testing

permissions:
  contents: write   # needed to upload release assets
  packages: read    # needed to pull GHCR image

jobs:
  # 1. Linux job that INVOKES the MSVC 2003 container via docker run
  build-linux-container:
    # Only run:
    # - in the original repo (not forks)
    if: github.repository_owner == 'OpenJE'

    runs-on: ubuntu-latest

    steps:
      - name: Checkout source
        uses: actions/checkout@v4
        with:
            submodules: recursive
            fetch-depth: 0

      - name: Log in to GitHub Container Registry
        run: |
          echo "${{ secrets.GITHUB_TOKEN }}" |
            docker login ghcr.io -u "${{ github.actor }}" --password-stdin

      - name: Pull docker container (MSVC 2002)
        run: |
          docker pull ghcr.io/openje/msvc2002:latest

      - name: Build with MSVC 2002
        shell: bash
        working-directory: ${{ github.workspace }}
        run: |
          mkdir -p obj
          mkdir -p openje/obj
          mkdir -p tracing/obj
          mkdir -p build
        
          # 1) Fix permissions on the mounted repo so UID 1000 can write
          docker run --rm \
            -u 0:0 \
            -v "$PWD":"$PWD" \
            -w "$PWD" \
            ghcr.io/openje/msvc2002:latest \
            -lc 'chown -R 1000:1000 "$PWD"'
      
          # 2) Run the actual build as UID 1000 (from Dockerfile USER 1000:1000)
          docker run --rm \
            -v "$PWD":"$PWD" \
            -w "$PWD" \
            ghcr.io/openje/msvc2002:latest \
            -lc 'nmake /f Makefile'

      - name: Locate EXE
        id: find-exe
        run: |
          set -e
          exe=$(find . -maxdepth 6 -type f -iname '*.exe' | head -n 1)
          if [ -z "$exe" ]; then
            echo "No EXE found" >&2
            exit 1
          fi
          echo "exe=$exe" >> "$GITHUB_OUTPUT"
          echo "Found: $exe"

      - name: Upload EXE to this GitHub Release
        if: github.event_name == 'release'
        uses: actions/upload-release-asset@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          upload_url: ${{ github.event.release.upload_url }}
          asset_path: ${{ steps.find-exe.outputs.exe }}
          asset_name: MyProgram-container-${{ github.ref_name }}.exe
          asset_content_type: application/octet-stream

  # 2. Windows job using latest MSVC on windows-latest, with nmake
  build-windows-msvc:
    # Run on forks (i.e., not the original repo owner)
    if: github.repository_owner != 'OpenJE'

    runs-on: windows-latest

    steps:
      - name: Checkout source
        uses: actions/checkout@v4
        with:
            submodules: recursive
            fetch-depth: 0

      # Set up the Visual C++ build environment (nmake, cl, etc.)
      - name: Set up MSVC Developer Command Prompt
        uses: ilammy/msvc-dev-cmd@v1
        with:
          arch: x86   # or x64, adjust for your app

      - name: Build with nmake (latest MSVC)
        run: |
          REM If you use a specific .mak file, do:
          REM nmake /f path\to\your.mak
          nmake

      - name: Locate EXE
        id: find-exe
        shell: pwsh
        run: |
          $exe = Get-ChildItem -Path . -Recurse -Filter *.exe | Select-Object -First 1
          if (-not $exe) {
            Write-Error "No EXE found"
            exit 1
          }
          "exe=$($exe.FullName)" >> $env:GITHUB_OUTPUT
          Write-Host "Found: $($exe.FullName)"

      - name: Upload EXE to this GitHub Release
        if: github.event_name == 'release'
        uses: actions/upload-release-asset@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          upload_url: ${{ github.event.release.upload_url }}
          asset_path: ${{ steps.find-exe.outputs.exe }}
          asset_name: MyProgram-msvc-${{ github.ref_name }}.exe
          asset_content_type: application/octet-stream
